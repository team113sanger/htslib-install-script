stages:
  - test

include:
  - project: 'team113sanger/common/cicd-template'
    ref: 0.3.3 # Use the latest Git Tag or if experimenting with new components use a Git SHA
    file: '.gitlab-ci-components.yml'


#############
# TEMPLATES #
#############

.generic-variables:
  extends:
    - .component-variables
  variables:
    USE_DOCKER_TARGET_STAGE: 1
    DOCKER_BUILDKIT: 1
    DOCKER_TARGET_STAGE: test
    TEST_FILE: run_tests.sh
    DOCKERFILE_PATH: "" # Must be set in the job definition
    DOCKER_BUILD_CONTEXT: .
    HTSLIB_VERSION: "1.14"

.generic-script:
  script:
    - echo "Running a build and then test for the image"
    # 
    - echo "DOCKERFILE_PATH=${DOCKERFILE_PATH}"
    - echo "DOCKER_TARGET_STAGE=${DOCKER_TARGET_STAGE}"
    - echo "CANDIDATE_IMAGE=${CANDIDATE_IMAGE}"
    - echo "DOCKER_BUILD_CONTEXT=${DOCKER_BUILD_CONTEXT}"
    - echo "TEST_FILE=${TEST_FILE}"
    - echo "HTSLIB_VERSION=${HTSLIB_VERSION}"
    #
    - test -f ${DOCKERFILE_PATH:?}
    #
    # Build the image
    #
    - BUILD_CMD="docker build --target ${DOCKER_TARGET_STAGE:?} -t ${CANDIDATE_IMAGE:?} -f ${DOCKERFILE_PATH:?} --build-arg HTSLIB_VERSION=${HTSLIB_VERSION:?} --progress=plain ${DOCKER_BUILD_CONTEXT:?}"
    - echo "Running build command ${BUILD_CMD}"
    - eval ${BUILD_CMD}
    #
    # Test the image
    #
    - docker run --rm ${CANDIDATE_IMAGE:?} ls -l ${TEST_FILE:?}
    - docker run --rm ${CANDIDATE_IMAGE:?} bash ${TEST_FILE:?} ${HTSLIB_VERSION:?}
    - echo "Build and test completed successfully"

.template_job__build_and_test:
  extends:
    - .generic-variables
    - .component-before_script
    - .generic-script
    - .component-after_script
    - .component-tags-shared-runner

############
#   JOBS   #
############

test-ubuntu22-usr_local:
  stage: test
  variables:
    PRE_FETCH_BASE_IMAGE: ubuntu:22.04
    IMAGE_TAG_SUFFIX: "-ubuntu22.usr_local"
    DOCKERFILE_PATH: Dockerfile.ubuntu22.usr_local
  extends:
      - .template_job__build_and_test

test-ubuntu22-custom:
  stage: test
  variables:
    PRE_FETCH_BASE_IMAGE: ubuntu:22.04
    IMAGE_TAG_SUFFIX: "-ubuntu22.custom"
    DOCKERFILE_PATH: Dockerfile.ubuntu22.custom
  extends:
      - .template_job__build_and_test

test-base_r-usr_local:
  stage: test
  variables:
    PRE_FETCH_BASE_IMAGE: r-base:4.2.3
    IMAGE_TAG_SUFFIX: "-rbase.usr_local"
    DOCKERFILE_PATH: Dockerfile.rbase.usr_local
  extends:
      - .template_job__build_and_test

test-base_r-custom:
  stage: test
  variables:
    PRE_FETCH_BASE_IMAGE: r-base:4.2.3
    IMAGE_TAG_SUFFIX: "-rbase.custom"
    DOCKERFILE_PATH: Dockerfile.rbase.custom
  extends:
      - .template_job__build_and_test

test-python-usr_local:
  stage: test
  variables:
    PRE_FETCH_BASE_IMAGE: python:3.11.9-slim-bookworm
    IMAGE_TAG_SUFFIX: "-python.usr_local"
    DOCKERFILE_PATH: Dockerfile.python.usr_local
  extends:
      - .template_job__build_and_test

test-python-custom:
  stage: test
  variables:
    PRE_FETCH_BASE_IMAGE: python:3.11.9-slim-bookworm
    IMAGE_TAG_SUFFIX: "-python.custom"
    DOCKERFILE_PATH: Dockerfile.python.custom
  extends:
      - .template_job__build_and_test